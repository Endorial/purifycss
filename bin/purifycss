#!/usr/bin/env node
const yargs = require("yargs")
const fs = require("fs")
const path = require("path")
const { hideBin } = require("yargs/helpers")
const purify = require("../lib/purifycss.js")

const argv = yargs(hideBin(process.argv))
    .usage("$0 [options]")
    .option("css", {
        description: "CSS files to purify",
        type: "array",
        demandOption: true
    })
    .option("c", {
        alias: "content",
        description: "Content files or globs to search for used selectors",
        type: "array",
        demandOption: true
    })
    .option("o", {
        alias: "out",
        description: "Filepath to write purified CSS to",
        type: "string"
    })
    .option("m", {
        alias: "min",
        description: "Minify CSS",
        type: "boolean",
        default: false
    })
    .option("i", {
        alias: "info",
        description: "Logs info on how much CSS was removed",
        type: "boolean",
        default: false
    })
    .option("r", {
        alias: "rejected",
        description: "Logs the CSS rules that were removed",
        type: "boolean",
        default: false
    })
    .option("w", {
        alias: "whitelist",
        description: "List of selectors that should not be removed",
        type: "array",
        default: []
    })
    .option("s", {
        alias: "safelist",
        description: "Alias for --whitelist",
        type: "array",
        default: []
    })
    .help()
    .alias("h", "help")
    .version()
    .alias("v", "version")
    .argv

// Combine whitelist and safelist
const whitelist = [...(argv.whitelist || []), ...(argv.safelist || [])]

const cssFiles = argv.css
const contentFiles = argv.content

// Validate that CSS files exist
cssFiles.forEach(file => {
    if (!fs.existsSync(file)) {
        console.error(`Error: CSS file '${file}' does not exist`)
        process.exit(1)
    }
})

// Validate that content files exist (if not globs)
contentFiles.forEach(pattern => {
    // For now, just check if it's a direct file path
    if (!pattern.includes('*') && !fs.existsSync(pattern)) {
        console.error(`Error: Content file '${pattern}' does not exist`)
        process.exit(1)
    }
})

const options = {
    minify: argv.min,
    info: argv.info,
    rejected: argv.rejected,
    output: argv.out,
    whitelist: whitelist
}

try {
    const result = purify(contentFiles, cssFiles, options)
    if (!options.output) {
        console.log(result)
    }
} catch (error) {
    console.error(`Error: ${error.message}`)
    process.exit(1)
}
